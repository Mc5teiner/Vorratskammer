
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>📦 Vorratskammer</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    #videoWrapper { display: none; margin-top: 10px; }
    video { width: 100%; border: 2px solid #ccc; }
  </style>
</head>
<body class="bg-light">

<div class="container my-4">
  <h1 class="text-center mb-4">📦 Vorratskammer</h1>

  <div class="d-flex gap-2 mb-3">
    <button type="button" class="btn btn-secondary flex-fill" id="startScan">📷 Barcode hinzufügen</button>
    <button type="button" class="btn btn-outline-dark flex-fill" id="startSearch">🔍 Barcode suchen</button>
  </div>

  <div id="videoWrapper"><video id="video"></video></div>

  <form id="itemForm" class="row g-2 mt-2">
    <div class="col-12">
      <input type="text" id="barcode" class="form-control" placeholder="Barcode (automatisch)" readonly />
    </div>
    <div class="col-6">
      <input type="text" id="name" class="form-control" placeholder="Name" required>
    </div>
    <div class="col-3">
      <input type="number" id="quantity" class="form-control" placeholder="Menge" required>
    </div>
    <div class="col-3">
      <input type="text" id="unit" class="form-control" placeholder="Einheit" required>
    </div>
    <div class="col-6">
      <input type="date" id="expiry" class="form-control" required>
    </div>
    <div class="col-6">
      <input type="text" id="location" class="form-control" placeholder="Ort" required>
    </div>
    <div class="col-12 d-grid">
      <button type="submit" class="btn btn-primary">Hinzufügen</button>
    </div>
  </form>

  <hr>
  <input type="text" id="search" class="form-control mb-3" placeholder="Suchen..." oninput="renderTable()">

  <table class="table table-bordered table-striped">
    <thead class="table-light">
      <tr>
        <th>Name</th>
        <th>Menge</th>
        <th>Einheit</th>
        <th>MHD</th>
        <th>Ort</th>
        <th>Aktion</th>
      </tr>
    </thead>
    <tbody id="inventoryTable"></tbody>
  </table>

  <hr>
  <h4>🛒 Einkaufsliste</h4>
  <ul id="shoppingList" class="list-group mb-4"></ul>
</div>

<script type="module">
  import { BrowserMultiFormatReader } from 'https://cdn.jsdelivr.net/npm/@zxing/browser@0.0.10/+esm';

  const codeReader = new BrowserMultiFormatReader();
  const videoElem = document.getElementById('video');
  const videoWrapper = document.getElementById('videoWrapper');

  async function scanBarcode(callback) {
    try {
      videoWrapper.style.display = 'block';
      const result = await codeReader.decodeOnceFromVideoDevice(undefined, 'video');
      videoWrapper.style.display = 'none';
      callback(result.getText());
    } catch (err) {
      alert('Scan fehlgeschlagen: ' + err);
      videoWrapper.style.display = 'none';
    }
  }

  document.getElementById('startScan').addEventListener('click', () => {
    scanBarcode((code) => {
      document.getElementById('barcode').value = code;
      fetchProductInfo(code);
    });
  });

  document.getElementById('startSearch').addEventListener('click', () => {
    scanBarcode((code) => {
      document.getElementById('search').value = code;
      renderTable();
    });
  });
</script>

<script>
let inventory = JSON.parse(localStorage.getItem('inventory')) || [];
let shoppingList = JSON.parse(localStorage.getItem('shoppingList')) || [];

document.getElementById('itemForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const item = {
    id: Date.now(),
    barcode: document.getElementById('barcode').value,
    name: document.getElementById('name').value,
    quantity: parseFloat(document.getElementById('quantity').value),
    unit: document.getElementById('unit').value,
    expiry: document.getElementById('expiry').value,
    location: document.getElementById('location').value
  };
  inventory.push(item);
  if (item.quantity === 0) addToShoppingList(item.name);
  saveAndRender();
  this.reset();
});

function deleteItem(id) {
  inventory = inventory.filter(item => item.id !== id);
  saveAndRender();
}

function addToShoppingList(name) {
  if (!shoppingList.includes(name)) {
    shoppingList.push(name);
    saveAndRender();
  }
}

function removeFromShoppingList(name) {
  shoppingList = shoppingList.filter(item => item !== name);
  saveAndRender();
}

function changeQuantity(id, delta) {
  const index = inventory.findIndex(item => item.id === id);
  if (index !== -1) {
    inventory[index].quantity += delta;
    if (inventory[index].quantity < 0) inventory[index].quantity = 0;
    if (inventory[index].quantity === 0) addToShoppingList(inventory[index].name);
    saveAndRender();
  }
}

function saveAndRender() {
  localStorage.setItem('inventory', JSON.stringify(inventory));
  localStorage.setItem('shoppingList', JSON.stringify(shoppingList));
  renderTable();
  renderShoppingList();
}

function renderTable() {
  const tbody = document.getElementById('inventoryTable');
  const search = document.getElementById('search').value.toLowerCase();
  tbody.innerHTML = '';

  inventory
    .filter(item =>
      item.name.toLowerCase().includes(search) ||
      item.location.toLowerCase().includes(search) ||
      item.barcode?.includes(search)
    )
    .sort((a, b) => new Date(a.expiry) - new Date(b.expiry))
    .forEach(item => {
      const expired = new Date(item.expiry) < new Date();
      const row = document.createElement('tr');
      if (expired) row.classList.add('table-danger');
      row.innerHTML = `
        <td>${item.name}</td>
        <td>
          <div class="d-flex align-items-center gap-2">
            <button class="btn btn-sm btn-outline-secondary" onclick="changeQuantity(${item.id}, -1)">–</button>
            ${item.quantity}
            <button class="btn btn-sm btn-outline-secondary" onclick="changeQuantity(${item.id}, 1)">+</button>
          </div>
        </td>
        <td>${item.unit}</td>
        <td>${item.expiry}</td>
        <td>${item.location}</td>
        <td>
          <button class="btn btn-sm btn-danger mb-1" onclick="deleteItem(${item.id})">🗑</button><br>
          <button class="btn btn-sm btn-outline-primary" onclick="addToShoppingList('${item.name}')">🛒</button>
        </td>
      `;
      tbody.appendChild(row);
    });
}

function renderShoppingList() {
  const ul = document.getElementById('shoppingList');
  ul.innerHTML = '';
  shoppingList.forEach(item => {
    const li = document.createElement('li');
    li.className = 'list-group-item d-flex justify-content-between align-items-center';
    li.innerHTML = `
      ${item}
      <button class="btn btn-sm btn-outline-danger" onclick="removeFromShoppingList('${item}')">Entfernen</button>
    `;
    ul.appendChild(li);
  });
}

async function fetchProductInfo(barcode) {
  try {
    const response = await fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`);
    const data = await response.json();
    if (data.status === 1) {
      const product = data.product;
      document.getElementById('name').value = product.product_name || '';
      document.getElementById('unit').value = product.quantity || '';
    } else {
      alert("Produkt nicht gefunden. Bitte manuell eingeben.");
    }
  } catch (error) {
    alert("Fehler beim Abrufen der Produktdaten.");
  }
}

renderTable();
renderShoppingList();
</script>

</body>
</html>
